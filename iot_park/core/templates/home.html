{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %}
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
<main class="content">
    {% include 'includes/navigation.html' %}
    <div class="row">
        <div class="col-12 col-lg-8">
            <div class="row">
                <!-- Camera V√†o -->
                <div class="col-6 mb-3">
                    <div class="card border-light shadow-sm">
                        <div class="card-header py-2">
                            <h2 class="h6 mb-0">üé• C·ªïng V√†o</h2>
                        </div>
                        <div class="card-body py-2">
                            {% if camera_entry %}
                            <div class="text-center mb-2">
                                <img src="{{ camera_entry.stream_url }}" class="img-fluid rounded border" style="max-height:250px;object-fit:cover;">
                            </div>
                            <div id="realtime-entry" class="text-center mb-2 text-muted fst-italic">‚è≥ ƒêang ch·ªù d·ªØ li·ªáu c·ªïng v√†o...</div>
                            <div><strong>üì∑ Bi·ªÉn s·ªë v√†o:</strong> <span id="plate-entry">{{ plate_number_entry }}</span></div>
                            {% else %}<p class="text-danger">‚ö†Ô∏è Kh√¥ng c√≥ camera c·ªïng v√†o.</p>{% endif %}
                        </div>
                    </div>
                </div>
                <!-- Camera Ra -->
                <div class="col-6 mb-3">
                    <div class="card border-light shadow-sm">
                        <div class="card-header py-2">
                            <h2 class="h6 mb-0">üé• C·ªïng Ra</h2>
                        </div>
                        <div class="card-body py-2">
                            {% if camera_exit %}
                            <div class="text-center mb-2">
                                <img src="{{ camera_exit.stream_url }}" class="img-fluid rounded border" style="max-height:250px;object-fit:cover;">
                            </div>
                            <div id="realtime-exit" class="text-center mb-2 text-muted fst-italic">‚è≥ ƒêang ch·ªù d·ªØ li·ªáu c·ªïng ra...</div>
                            <div><strong>üì∑ Bi·ªÉn s·ªë ra:</strong> <span id="plate-exit">{{ plate_number_exit }}</span></div>
                            {% else %}<p class="text-danger">‚ö†Ô∏è Kh√¥ng c√≥ camera c·ªïng ra.</p>{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="card border-light shadow-sm">
                <div class="card-body border-bottom">
                    <div class="h6 font-weight-normal text-gray mb-2">üöó Th√¥ng tin xe</div>
                </div>
                <div class="card-body p-2">
                    <form id="vehicle-info-form">
                        <div class="row">
                            <div class="mb-2 col-6">
                                <label class="form-label">üì∑ Bi·ªÉn s·ªë</label>
                                <input type="text" class="form-control form-control-sm" id="input-plate-number" readonly>
                            </div>
                            <div class="mb-2 col-6">
                                <label class="form-label">üîê RFID</label>
                                <input type="text" class="form-control form-control-sm" id="input-rfid-code" readonly>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-2 col-6">
                                <label class="form-label">üïì Gi·ªù v√†o</label>
                                <input type="text" class="form-control form-control-sm" id="input-entry-time" readonly>
                            </div>
                            <div class="mb-2 col-6">
                                <label class="form-label">üïî Gi·ªù ra</label>
                                <input type="text" class="form-control form-control-sm" id="input-exit-time" readonly>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-2 col-12">
                                <label class="form-label">üìÑ Tr·∫°ng th√°i</label>
                                <input type="text" class="form-control form-control-sm" id="input-status" readonly style="display:none;">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <button class="btn btn-success w-100 mb-2" type="button" id="btnOpenGateIn">üöß M·ªü c·ªïng v√†o</button>
                                <button class="btn btn-secondary w-100" type="button" id="btnManualModeIn">‚öôÔ∏è Th·ªß c√¥ng v√†o</button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-danger w-100 mb-2" type="button" id="btnOpenGateOut">üöß M·ªü c·ªïng ra</button>
                                <button class="btn btn-secondary w-100" type="button" id="btnManualModeOut">‚öôÔ∏è Th·ªß c√¥ng ra</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock content %}

{% block javascripts %}
<script>
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const socket = new WebSocket(`${ws_scheme}://${window.location.host}/ws/access-events/`);

    socket.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            if (data.type === "access_event") {
                const { position, license_plate, image_url, status, rfid, check_in, check_out } = data;
                const html = `<img src="${image_url}" class="img-fluid rounded border mb-2" style="max-height:200px;object-fit:cover;"><div><strong>üì∑ Bi·ªÉn s·ªë:</strong> ${license_plate || '‚Äî'}</div>`;

                if (position === "entry") {
                    document.getElementById("realtime-entry").innerHTML = html;
                    document.getElementById("plate-entry").innerText = license_plate || "‚Äî";
                } else if (position === "exit") {
                    document.getElementById("realtime-exit").innerHTML = html;
                    document.getElementById("plate-exit").innerText = license_plate || "‚Äî";
                }

                document.getElementById("input-plate-number").value = license_plate || "";
                document.getElementById("input-rfid-code").value = rfid || "";
                document.getElementById("input-entry-time").value = check_in ? new Date(check_in).toLocaleString() : "";
                document.getElementById("input-exit-time").value = check_out ? new Date(check_out).toLocaleString() : "";

                const statusField = document.getElementById("input-status");
                switch (status) {
                    case "chua_co_thong_tin":
                        statusField.value = "Ch∆∞a c√≥ th√¥ng tin xe ƒëƒÉng k√Ω";
                        statusField.className = "form-control form-control-sm text-danger";
                        break;
                    case "xe_da_trong_bai":
                        statusField.value = "Xe ƒë√£ v√†o nh∆∞ng ch∆∞a ra";
                        statusField.className = "form-control form-control-sm text-warning";
                        break;
                    case "checkin_thanh_cong":
                        statusField.value = "Xe v√†o th√†nh c√¥ng";
                        statusField.className = "form-control form-control-sm text-success";
                        break;
                    case "checkin_khach_thanh_cong":
                        statusField.value = "Kh√°ch v√†o th√†nh c√¥ng";
                        statusField.className = "form-control form-control-sm text-success";
                        break;
                    case "checkout_thanh_cong":
                        statusField.value = "Xe ra th√†nh c√¥ng";
                        statusField.className = "form-control form-control-sm text-success";
                        break;
                    case "so_du_khong_du":
                        statusField.value = "Kh√¥ng ƒë·ªß s·ªë d∆∞ ƒë·ªÉ thanh to√°n";
                        statusField.className = "form-control form-control-sm text-danger";
                        break;
                    case "cho_thanh_toan":
                        statusField.value = "Ch·ªù thanh to√°n b·∫±ng QR";
                        statusField.className = "form-control form-control-sm text-warning";
                        break;
                    case "rfid_dang_duoc_su_dung":
                        statusField.value = "RFID ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng";
                        statusField.className = "form-control form-control-sm text-warning";
                        break;
                    case "bien_so_da_duoc_dang_ky":
                        statusField.value = "Bi·ªÉn s·ªë ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω";
                        statusField.className = "form-control form-control-sm text-danger";
                        break;
                    case "khong_tim_thay_log_checkin":
                        statusField.value = "Kh√¥ng t√¨m th·∫•y l∆∞·ª£t v√†o";
                        statusField.className = "form-control form-control-sm text-danger";
                        break;
                    case "xe_chua_vao":
                        statusField.value = "Xe ch∆∞a t·ª´ng v√†o b√£i";
                        statusField.className = "form-control form-control-sm text-danger";
                        break;
                    default:
                        statusField.value = "";
                        statusField.className = "form-control form-control-sm";
                        statusField.style.display = "none";
                        return;
                }
                statusField.style.display = "block";
            }
        } catch (err) {
            console.warn("\u26a0\ufe0f L·ªói khi parse JSON:", event.data);
        }
    };
</script>
{% endblock javascripts %}
